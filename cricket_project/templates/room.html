<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🎮 Hand Cricket Lobby & Multiplayer Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* (Same styles as before; you can copy all CSS from your previous version) */
    /* … */
    /* Add confetti-piece styles from game_bot */
  </style>
</head>
<body>
  <!-- LOBBY UI (unchanged) -->
  <div class="lobby"> … </div>

  <!-- GAME UI -->
  <div class="game-container" id="game">
    <h3 id="target-display" style="margin:10px; display:none;">🎯 Target: --</h3>
    <h2 id="game-status">🕹️ Get Ready...</h2>
    <div id="play-buttons" class="hidden">
      <p>🎯 Choose your number:</p>
      <div>
        <button onclick="playNum(0)">0</button>
        <button onclick="playNum(1)">1</button>
        <button onclick="playNum(2)">2</button>
        <button onclick="playNum(3)">3</button>
        <button onclick="playNum(4)">4</button>
        <button onclick="playNum(5)">5</button>
      </div>
    </div>
    <div>
      <h3>📜 Scoreboard</h3>
      <ul id="history" style="list-style:none; padding-left:0;"></ul>
    </div>
    <div class="chat-box"> … </div>
    <button id="reset-btn" class="btn hidden">⟲ Reset</button>
    <div class="confetti" id="confetti"></div>
  </div>

  <script>
  const socket = io();
  const params = new URLSearchParams(window.location.search);
  const room = params.get('room');
  const username = params.get('username') || 'Player';
  const isHost = params.get('host') === 'true';
  let sid = "", innings = 1, myScore = 0, opponentScore = 0;
  let isMyTurnToBat = false, target = null, gameEnded = false;

  // UI elements
  const targetDisplay = document.getElementById("target-display");
  const gameStatus = document.getElementById("game-status");
  const playButtons = document.getElementById("play-buttons");
  const historyList = document.getElementById("history");
  const resetBtn = document.getElementById("reset-btn");
  const confettiEl = document.getElementById("confetti");

  document.getElementById("room-code").innerText = room;

  socket.on('connect', () => {
    sid = socket.id;
    socket.emit('join_room', { room, host: isHost, username });
  });

  // Lobby & toss logic unchanged...
  socket.on('both_ready', () => { /* ... */ });
  function chooseToss(choice){ /* ... */ }
  socket.on('toss_result', data => { /* ... */ });
  function chooseBatBowl(choice){ /* ... */ }

  socket.on("game_start", data => {
    document.querySelector(".lobby").style.display = "none";
    document.getElementById("game").style.display = "flex";
    isMyTurnToBat = data.bat_first_sid === sid;
    innings = 1;
    myScore = opponentScore = 0;
    target = null;
    gameEnded = false;
    historyList.innerHTML = "";
    resetBtn.classList.add("hidden");
    updateGameStatus();
    playButtons.classList.remove("hidden");
  });

  function updateGameStatus(){
    if(innings === 1){
      gameStatus.innerText = isMyTurnToBat ? "🏏 You are Batting!" : "🥎 You are Bowling!";
      targetDisplay.style.display = "none";
    } else {
      targetDisplay.style.display = "block";
      targetDisplay.innerText = `🎯 Target: ${target}`;
      gameStatus.innerText = isMyTurnToBat
        ? `🏏 Batting – Target: ${target}`
        : `🥎 Bowling – Defend ${target}`;
    }
  }

  function playNum(n) {
    if(gameEnded) return;
    socket.emit("player_move", { room, move: n });
    playButtons.classList.add("hidden");
    gameStatus.innerText = "⏳ Waiting for opponent...";
  }

  socket.on("round_result", data => {
    if(gameEnded) return;

    const li = document.createElement("li");
    const myMove = data.moves[sid];
    const opponentId = Object.keys(data.moves).find(id => id !== sid);
    const opponentMove = data.moves[opponentId];
    const myName = data.usernames[sid];
    const oppName = data.usernames[opponentId];

    if(data.type === "out"){
      li.textContent = `💥 OUT! Both played ${data.num}`;
      historyList.appendChild(li);

      if(innings === 1){
        target = isMyTurnToBat ? myScore + 1 : opponentScore + 1;
        innings = 2;
        isMyTurnToBat = !isMyTurnToBat;
        historyList.appendChild(document.createElement("hr"));
        updateGameStatus();
      } else {
        const won = !isMyTurnToBat;
        endGame(won);
        return;
      }
    } else {
      li.textContent = `${myName}: ${myMove} | ${oppName}: ${opponentMove}`;
      historyList.appendChild(li);

      if(isMyTurnToBat) {
        myScore += myMove;
        if(innings === 2 && myScore >= target){
          endGame(true);
          return;
        }
      } else {
        opponentScore += opponentMove;
        if(innings === 2 && opponentScore >= target){
          endGame(false);
          return;
        }
      }
    }

    playButtons.classList.remove("hidden");
    updateGameStatus();
  });

  function endGame(won){
    gameEnded = true;
    gameStatus.innerText = won ? "🎉 You Won! 🏆" : "😢 You Lost!";
    playButtons.classList.add("hidden");
    resetBtn.classList.remove("hidden");
    if(won) showConfetti();
  }

  resetBtn.onclick = () => {
    socket.emit("restart_game", { room });
  };

  function showConfetti(){
    window.confetti({ particleCount:200, spread:90, origin:{ y:0.6 } });
  }

  // Chat logic unchanged
  function sendMsg(){ /* ... */ }
  socket.on("receive_message", ({ username, message }) => { /* ... */ });
  </script>
</body>
</html>
