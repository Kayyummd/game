<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŽ® Hand Cricket Multiplayer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    html, body {
      margin:0; padding:0; height:100%;
      font-family:'Press Start 2P',cursive;
      background:#000; color:#0ff;
      overflow:hidden;
    }
    .top-bar {
      padding:10px; text-align:center; font-size:12px;
      background:#0008; border-bottom:2px solid #0ff;
    }
    .container {
      display:flex; justify-content:center; align-items:flex-start;
      gap:20px; padding:20px;
    }
    .game, .chat {
      background:#0008; border:3px solid #0ff; padding:15px;
      box-shadow:0 0 15px #0ff;
    }
    .game { flex:3; text-align:center; }
    .chat { flex:1; display:flex; flex-direction:column; max-height:500px; }
    #history, #chat-messages { overflow-y:auto; font-size:10px; flex:1; margin-bottom:10px; }
    #history li, #chat-messages div { margin:4px 0; }
    button, input {
      font-family:inherit; background:#000; color:#0ff;
      border:2px solid #0ff; padding:5px; font-size:10px;
    }
    button:hover, input:focus { background:#0ff; color:#000; }
    .hidden { display:none; }
    .confetti { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; }
  </style>
</head>
<body>
  <div class="top-bar" id="top-usernames">Player1 vs Player2</div>

  <div class="container">
    <div class="game">
      <div id="status">Waiting for players...</div>

      <div id="toss" class="hidden">
        <p>Select Head or Tail</p>
        <button onclick="doToss('Head')">Head</button>
        <button onclick="doToss('Tail')">Tail</button>
      </div>

      <div id="batbowl" class="hidden">
        <p>You won toss! Bat or Bowl?</p>
        <button onclick="choose('Bat')">Bat</button>
        <button onclick="choose('Bowl')">Bowl</button>
      </div>

      <div id="play" class="hidden">
        <p>Choose a number 0â€‘5</p>
        <div>
          <button onclick="play(0)">0</button>
          <button onclick="play(1)">1</button>
          <button onclick="play(2)">2</button>
          <button onclick="play(3)">3</button>
          <button onclick="play(4)">4</button>
          <button onclick="play(5)">5</button>
        </div>
      </div>

      <h4 id="target" class="hidden">ðŸŽ¯ Target: --</h4>

      <h4>Scoreboard</h4>
      <ul id="history"></ul>

      <button id="reset" class="hidden">Restart Game</button>
      <div class="confetti" id="confetti"></div>
    </div>

    <div class="chat">
      <h4>Chat</h4>
      <div id="chat-messages"></div>
      <div>
        <input id="chat-input" placeholder="Type your message..."/>
        <button onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const room = params.get('room');
    const username = params.get('username') || 'Player';
    let myId, battingSid;

    // Join room
    socket.on('connect', () => {
      myId = socket.id;
      socket.emit('join_room', {room, username});
    });

    // Update usernames
    socket.on('usernames', ({player1,player2})=>{
      document.getElementById('top-usernames').textContent = `${player1} vs ${player2}`;
      document.getElementById('status').textContent = 'Waiting for toss...';
      document.getElementById('toss').classList.remove('hidden');
    });

    // Toss result
    function doToss(choice){ socket.emit('toss_choice',{room,choice}); }
    socket.on('toss_result', data => {
      const won = (data.winner==='host' && myId===socket.id) || (data.winner==='guest' && myId!==socket.id);
      document.getElementById('toss').classList.add('hidden');
      document.getElementById('status').textContent = `Toss: ${data.result}. ${won?'You':'Opponent'} won.`;
      if(won) document.getElementById('batbowl').classList.remove('hidden');
    });

    // Bat or bowl
    function choose(choice){ socket.emit('bat_bowl_choice',{room,choice}); }
    socket.on('game_start', data => {
      battingSid = data.bat_first_sid;
      document.getElementById('batbowl').classList.add('hidden');
      document.getElementById('status').textContent = 'Game started!';
      showPlay();
    });

    // Show play buttons
    function showPlay(){
      document.getElementById('play').classList.remove('hidden');
      document.getElementById('status').textContent = (myId===battingSid)?'You are batting':'You are bowling';
    }

    // Play number
    function play(n){
      socket.emit('player_move',{room,move:n});
      document.getElementById('play').classList.add('hidden');
      document.getElementById('status').textContent = 'Waiting for opponent...';
    }

    // Handle rounds & results
    socket.on('round_result', data => {
      const {moves,type, scores, target: tgt} = data;
      const other = Object.keys(moves).find(id=>id!==myId);
      const myMove = moves[myId], hisMove = moves[other];
      const out = type==='out';
      let line = `You:${myMove} Opp:${hisMove} ${out?'â€” OUT!':''}`;
      if(scores){
        line += ` | Score: ${scores[myId]||(0)}`;
      }
      const li = document.createElement('li'); li.textContent=line;
      document.getElementById('history').appendChild(li);

      if(tgt!==undefined){
        document.getElementById('target').classList.remove('hidden');
        document.getElementById('target').textContent=`ðŸŽ¯ Target: ${tgt}`;
      }

      if(data.game_over){
        endGame(data.winner_sid===myId);
      } else {
        showPlay();
      }
    });

    // Handle final game over
    function endGame(win){
      document.getElementById('status').textContent = win ? 'ðŸŽ‰ You Win!' : 'ðŸ’€ You Lose!';
      document.getElementById('reset').classList.remove('hidden');
      if(win) playConfetti();
    }

    document.getElementById('reset').onclick = ()=>location.reload();

    // Chat functionality
    function sendChat(){
      const msg = document.getElementById('chat-input').value.trim();
      if(!msg) return;
      socket.emit('send_message',{room,user:username,message:msg});
      document.getElementById('chat-input').value='';
    }

    socket.on('receive_message', data=>{
      const div = document.createElement('div');
      div.textContent = `${data.username}: ${data.message}`;
      document.getElementById('chat-messages').appendChild(div);
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    });

    // Confetti
    function playConfetti(){
      const end = Date.now()+2000;
      (function f(){
        confetti({startVelocity:30,spread:360,particleCount:10,origin:{x:Math.random(),y:Math.random()}});
        if(Date.now()<end) requestAnimationFrame(f);
      })();
    }
  </script>
</body>
</html>
