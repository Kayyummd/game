<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéÆ Hand Cricket Multiplayer Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Press Start 2P', cursive;
      background: black;
      overflow: hidden;
      color: #00ffcc;
    }

    .top-bar {
      width: 100%;
      padding: 10px;
      background-color: #000000cc;
      text-align: center;
      font-size: 12px;
      border-bottom: 2px solid #00ffcc;
      z-index: 10;
      position: relative;
    }

    .game-wrapper {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 1000px;
      margin: auto;
      z-index: 10;
      position: relative;
    }

    .game-container {
      flex: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      padding: 10px;
      background-color: #000000cc;
      box-shadow: 0 0 25px #00ffcc;
      border: 4px double #00ffcc;
    }

    .chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 20px 10px 20px 0;
      padding: 10px;
      background-color: #000000cc;
      border: 4px double #00ffcc;
      max-height: 500px;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      font-size: 10px;
      margin-bottom: 10px;
    }

    #chat-input {
      display: flex;
    }

    #chat-input input,
    #chat-input button,
    button {
      font-family: 'Press Start 2P', cursive;
      background-color: #000;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      padding: 5px;
      font-size: 10px;
    }

    #chat-input input {
      flex: 1;
    }

    #chat-input button, button {
      cursor: pointer;
    }

    button:hover {
      background-color: #00ffcc;
      color: #000;
    }

    #history {
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
      font-size: 10px;
      width: 100%;
    }

    .hidden {
      display: none;
    }

    .confetti {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>
<body>

  <!-- Game UI -->
  <div class="top-bar" id="top-usernames">Player 1 vs Player 2</div>

  <div class="game-wrapper">
    <div class="game-container" id="game">
      <h3 id="target-display" style="margin:10px; display:none;">üéØ Target: --</h3>
      <h2 id="game-status">üïπÔ∏è Get Ready...</h2>

      <div id="play-buttons" class="hidden">
        <p>üéØ Choose your number:</p>
        <div>
          <button onclick="playNum(0)">0</button>
          <button onclick="playNum(1)">1</button>
          <button onclick="playNum(2)">2</button>
          <button onclick="playNum(3)">3</button>
          <button onclick="playNum(4)">4</button>
          <button onclick="playNum(5)">5</button>
        </div>
      </div>

      <div>
        <h3>üìú Scoreboard</h3>
        <ul id="history" style="list-style:none; padding-left:0;"></ul>
      </div>

      <button id="reset-btn" class="hidden">‚ü≤ Reset</button>
      <div class="confetti" id="confetti"></div>
    </div>

    <div class="chat-box">
      <h3>üí¨ Chat</h3>
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input type="text" id="chatText" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Game Logic -->
  <script>
    const socket = io();
    const room = new URLSearchParams(window.location.search).get('room');
    const username = new URLSearchParams(window.location.search).get('username');
    let opponent = 'Opponent';
    let mySocketId = null;
    let isBatting = false;
    let isMyTurn = false;
    let myScore = 0;
    let target = null;
    let history = [];

    socket.on('connect', () => {
      mySocketId = socket.id;
      socket.emit('join_room', { room, username });
    });

    socket.on('usernames', data => {
      const { player1, player2 } = data;
      document.getElementById("top-usernames").innerText = `${player1} vs ${player2}`;
      opponent = (username === player1) ? player2 : player1;
    });

    socket.on('start_game', data => {
      isBatting = data.batting_sid === mySocketId;
      isMyTurn = isBatting;
      document.getElementById('game-status').innerText = isBatting ? "You're Batting" : "You're Bowling";
      document.getElementById('play-buttons').classList.remove('hidden');
    });

    function playNum(n) {
      if (!isMyTurn) return;
      socket.emit('play_move', { room, move: n });
      isMyTurn = false;
      document.getElementById('play-buttons').classList.add('hidden');
      document.getElementById('game-status').innerText = "Waiting for opponent...";
    }

    socket.on('round_result', data => {
      const { moves, result, runs, out, turn, inning, winner, target_score } = data;
      const myMove = moves[mySocketId];
      const otherId = Object.keys(moves).find(id => id !== mySocketId);
      const oppMove = moves[otherId];

      let msg = `You: ${myMove} | ${opponent}: ${oppMove}`;
      if (out) msg += " ‚Äî OUT!";
      if (runs !== undefined && !out && isBatting) {
        myScore += runs;
        msg += ` +${runs} runs`;
      }

      history.push(msg);
      document.getElementById('history').innerHTML = history.map(m => `<li>${m}</li>`).join('');

      if (target_score !== undefined) {
        target = target_score;
        document.getElementById("target-display").style.display = "block";
        document.getElementById("target-display").innerText = `üéØ Target: ${target}`;
      }

      if (winner) {
        document.getElementById('game-status').innerText = (winner === username) ? "üéâ You Win!" : "üíÄ You Lose!";
        document.getElementById('reset-btn').classList.remove('hidden');
        if (winner === username) confettiEffect();
      } else {
        isMyTurn = (turn === mySocketId);
        document.getElementById('play-buttons').classList.toggle('hidden', !isMyTurn);
        document.getElementById('game-status').innerText = isMyTurn
          ? (isBatting ? "You're Batting" : "You're Bowling")
          : "Waiting for opponent...";
      }
    });

    document.getElementById('reset-btn').onclick = () => {
      location.reload();
    };

    // Chat
    function sendMessage() {
      const msg = document.getElementById("chatText").value;
      if (msg.trim()) {
        socket.emit("chat", { room, user: username, message: msg });
        document.getElementById("chatText").value = "";
      }
    }

    socket.on("chat", data => {
      const div = document.createElement("div");
      div.innerText = `${data.user}: ${data.message}`;
      document.getElementById("chat-messages").appendChild(div);
      document.getElementById("chat-messages").scrollTop = document.getElementById("chat-messages").scrollHeight;
    });

    function confettiEffect() {
      const duration = 2 * 1000;
      const end = Date.now() + duration;
      (function frame() {
        confetti({
          particleCount: 3,
          angle: 60,
          spread: 55,
          origin: { x: 0 }
        });
        confetti({
          particleCount: 3,
          angle: 120,
          spread: 55,
          origin: { x: 1 }
        });
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      })();
    }
  </script>
</body>
</html>
